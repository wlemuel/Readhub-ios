//
//  SettingsViewController.swift
//  readhub
//
//  Created by Steve Lemuel on 11/8/19.
//  Copyright (c) 2019 Steve Lemuel. All rights reserved.
//
//  This file was generated by the ğŸ VIPER generator
//

import RxCocoa
import RxDataSources
import RxSwift
import SafariServices
import UIKit

final class SettingsViewController: UIViewController {
    // MARK: - Public properties -

    var presenter: SettingsPresenterInterface!

    // MARK: - Private properties -

    private var tableview: UITableView!

    private let disposeBag = DisposeBag()

    // MARK: - Lifecycle -

    override func viewDidLoad() {
        super.viewDidLoad()
        configure()

        setupLayout()
        setupRx()
    }
}

// MARK: - Extensions -

extension SettingsViewController: SettingsViewInterface {
}

private extension SettingsViewController {
    func configure() {
        let output = Settings.ViewOutput()

        _ = presenter.configure(with: output)
    }

    func setupLayout() {
        title = "è®¾ç½®"

        tableview = UITableView(frame: view.frame, style: .plain).then {
            $0.register(UITableViewCell.self, forCellReuseIdentifier: "Cell")
        }

        view.addSubview(tableview)
    }

    func setupRx() {
        let items = Observable.just([
            SectionModel(model: "è”ç³»", items: [
                SettingModel(type: .url, name: "åé¦ˆ", url: kFeedbackUrl),
                SettingModel(type: .plainUrl, name: "Telegram", descr: kTelegramUrl, url: kTelegramUrl),
            ]),
            SectionModel(model: "å…³äº", items: [
//                SettingModel(type: .url, name: "å¥½è¯„é¼“åŠ±", url: ""),
                SettingModel(type: .url, name: "é¡¹ç›® GitHub", url: kProjectUrl),
                SettingModel(type: .plain, name: "ç‰ˆæœ¬å·", descr: getVersion()),
            ]),
//            SectionModel(model: "æ”¯æŒä½œè€…", items: [
//                SettingModel(type: .support, name: "ğŸ˜„ $0.99 - Buy me a cup of coffee"),
//            ]),
        ])

        // åˆ›å»ºæ•°æ®æº
        let dataSource = RxTableViewSectionedReloadDataSource
        <SectionModel<String, SettingModel>>(configureCell: {
            _, tv, _, model in
            var cell = tv.dequeueReusableCell(withIdentifier: "Cell")

            switch model.type {
            case .url, .support:
                cell = UITableViewCell(style: .default, reuseIdentifier: "Cell")
                cell?.accessoryType = .disclosureIndicator
            case .plain, .plainUrl:
                cell = UITableViewCell(style: .value1, reuseIdentifier: "Cell")
                cell?.detailTextLabel?.text = model.descr
                cell?.detailTextLabel?.adjustsFontSizeToFitWidth = true
            }

            cell?.selectionStyle = .none
            cell?.textLabel?.text = model.name

            return cell!
        })

        dataSource.titleForHeaderInSection = { ds, index in
            ds.sectionModels[index].model
        }

        // ç»‘å®šå•å…ƒæ ¼æ•°æ®
        items
            .bind(to: tableview.rx.items(dataSource: dataSource))
            .disposed(by: disposeBag)

        tableview.rx.modelSelected(SettingModel.self)
            .subscribe(onNext: { [weak self] model in
                guard let `self` = self else { return }

                switch model.type {
                case .url, .plainUrl:
                    self.gotoUrl(rawUrl: model.url)
                default: break
                }
            }).disposed(by: disposeBag)
    }

    func gotoUrl(rawUrl: String) {
        if let url = URL(string: rawUrl) {
            let safariConfig = SFSafariViewController.Configuration()
            safariConfig.entersReaderIfAvailable = false

            let safariVC = SFSafariViewController(url: url, configuration: safariConfig)
            present(safariVC, animated: true, completion: nil)
        }
    }

    func getVersion() -> String {
        let infoDictionary = Bundle.main.infoDictionary
//        let appDisplayName = infoDictionary?["CFBundleDisplayName"] as! String
//        let minorVersion = infoDictionary?["CFBundleVersion"] as! String
        let majorVersion = infoDictionary?["CFBundleShortVersionString"] as! String

        // Device Info
//        let iosVersion : NSString = UIDevice.currentDevice().systemVersion //iosç‰ˆæœ¬
//        let identifierNumber = UIDevice.currentDevice().identifierForVendor //è®¾å¤‡udid
//        let systemName = UIDevice.currentDevice().systemName //è®¾å¤‡åç§°
//        let model = UIDevice.currentDevice().model //è®¾å¤‡å‹å·
//        let localizedModel = UIDevice.currentDevice().localizedModel //è®¾å¤‡åŒºåŸŸåŒ–å‹å·å¦‚A1533

        return majorVersion
    }
}
